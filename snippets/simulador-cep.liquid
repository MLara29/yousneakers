<style>
  .td-frete-dinamico {
    padding: 15px 10px;
    {% if settings.frete_dinamico_borda %}border: solid 1px #e8e8e8;{% endif %}
    border-radius: 10px;
    margin: {{ settings.frete_dinamico_spacetop }}px 0 {{ settings.frete_dinamico_spacebottom }}px;
  }
  .td-frete-dinamico-titulo {
    text-align: center; margin-bottom: 10px;font-size: 17px;
    font-weight: 600;

  }
  #td-frete-dinamico-cep {
    height: 40px;
    font-size: 15px;
    padding: 0 1rem;
    width: 50%;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    box-shadow: none !important;
    outline: none !important;
  }
  .td-frete-dinamico-content {
    display: flex;
    gap: 10px;
  }
  #td-frete-dinamico-btn {
    height: 40px; padding: .5rem;width: 50%;
    background: {{ settings.frete_dinamico_btn }};
    color:white;
        border: none;
    outline: none;
    box-shadow: none;
    border-radius: 4px;
  }
  .td-frete-dinamico-result {
    margin-top: 10px;
  }
  .td-frete-dinamico-location {
        font-size: 13px;
        color: #000;
  }
  .td-frete-dinamico-rate { color: #000; margin-top: 4px; }
  .td-frete-servico { color: #000; }
  .td-frete-preco { margin-left: 6px; }
  .td-frete-preco--risco { text-decoration: line-through; margin-left: 6px; }
  .td-frete-gratis { margin-left: 6px; font-weight: 600; color: #000; }
</style>
<div class="td-frete-dinamico">
  <div class="td-frete-dinamico-titulo">{{ settings.frete_dinamico_titulo }}</div>
      <div class="td-frete-dinamico-content">
        <input id="td-frete-dinamico-cep" type="text" placeholder="00000-000" autocomplete="CEP" wfd-id="id9">
        <button id="td-frete-dinamico-btn" data-text="Calcular" onclick="generateShippingRates(this)">Calcular</button>
      </div>
      <div class="td-frete-dinamico-result">
        <div id="frete-danger" class="alert alert-danger" role="alert" hidden="hidden"></div>
        <div id="frete-aviso" class="alert alert-warning" role="alert" hidden="hidden"></div>
        <div id="frete-sucesso" class="alert alert-success" role="alert" hidden="hidden"></div>
      </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // =============================== ATENÇÃO ===============================
    // CEP DO REMETENTE (ORIGEM):
    // Altere o valor abaixo para definir o CEP de origem utilizado pelo sistema.
    // Formato recomendado: 00000-000
    // Exemplo de uso: const SENDER_ZIP = '01001-000';
    // Quando precisar mudar o CEP do remetente, ALTERE APENAS ESTA LINHA.
    // ======================================================================
    const SENDER_ZIP = '35520-570';
    const SENDER_ZIP_UNMASKED = SENDER_ZIP.replace(/\D/g, '');

    window.generateShippingRates = async (btn) => {

        const spinnerHtml = `
          <div class="spinner-border spinner-border-sm" role="status" style="width: 1rem; height: 1rem">
            <span class="visually-hidden">Loading...</span>
          </div>
        `;
        btn.innerHTML = spinnerHtml;

        const wrapper = document.querySelector('.td-frete-dinamico');
        const zipInput = wrapper.querySelector('#td-frete-dinamico-cep');
        const zip = zipInput.value;


        wrapper.querySelector('#frete-danger').innerHTML = '';
        wrapper.querySelector('#frete-danger').setAttribute('hidden', 'hidden');
        wrapper.querySelector('#frete-aviso').innerHTML = '';
        wrapper.querySelector('#frete-aviso').setAttribute('hidden', 'hidden');
        wrapper.querySelector('#frete-sucesso').innerHTML = '';
        wrapper.querySelector('#frete-sucesso').setAttribute('hidden', 'hidden');

        const cepUnmasked = zip.replace(/\D/g, '');
        const cepRegex = /^[0-9]{8}$/;

        if (!cepRegex.test(cepUnmasked)) {
            console.warn("Formato de CEP inválido");
            wrapper.querySelector('#frete-aviso').innerHTML = `
              <p class="mb-0">Formato de CEP Inválido.</p>
            `;
            wrapper.querySelector('#frete-aviso').removeAttribute('hidden');
            btn.innerHTML = btn.dataset.text;
            return;
        }

        try {
            await tryCalculateShippingRates(btn, wrapper, cepUnmasked);
        } catch (error) {
            btn.innerHTML = btn.dataset.text;
        }
    };


    async function tryCalculateShippingRates(btn, wrapper, cepUnmasked) {
        // Shopify espera o nome completo do país. Para Brasil, use "Brazil".
        const country = 'Brazil';
        // Usar ViaCEP (CORS liberado) para obter a localização; se falhar, seguimos sem bloquear o cálculo.
        const viaCepUrl = `https://viacep.com.br/ws/${cepUnmasked}/json/`;

        let formattedLocation = '';
        let provinceName = '';
        let destUfCode = '';
        let destCity = '';
        try {
            const response = await fetch(viaCepUrl);
            if (response.ok) {
                const data = await response.json();
                if (!data.erro) {
                    formattedLocation = formatLocation(data);
                    provinceName = mapBrazilProvince(data.uf);
                    destUfCode = data.uf || '';
                    destCity = data.localidade || '';
                }
            }
        } catch (error) {
            // Ignorar falhas de localização para não bloquear cálculo de frete
        }

        // Buscar dados do CEP do remetente para estimativa de prazo baseada na origem
        let originUfCode = '';
        let originCity = '';
        try {
            const originResponse = await fetch(`https://viacep.com.br/ws/${SENDER_ZIP_UNMASKED}/json/`);
            if (originResponse.ok) {
                const originData = await originResponse.json();
                if (!originData.erro) {
                    originUfCode = originData.uf || '';
                    originCity = originData.localidade || '';
                }
            }
        } catch (error) {
            // Ignorar falhas na origem; se não disponível, seguimos sem estimativa customizada
        }

        // Logs informativos no console sobre a origem e destino
        console.log('[Frete Dinâmico] CEP remetente (origem):', SENDER_ZIP, `(unmasked: ${SENDER_ZIP_UNMASKED})`, '| UF:', originUfCode, '| Cidade:', originCity);
        console.log('[Frete Dinâmico] CEP destino:', cepUnmasked, '| UF:', destUfCode, '| Cidade:', destCity);

        if (formattedLocation) {
          wrapper.querySelector('#frete-sucesso').innerHTML = `
            <p class="td-frete-dinamico-location"><strong>${formattedLocation}</strong></p>
          `;
        }

        const province = provinceName;


        const cartResponse = await fetch('/cart.js', { method: 'GET' });
        const cartData = await cartResponse.json();

        const originalItems = cartData.items || [];
        const hasItems = originalItems.length > 0;

        if (hasItems) {
            const backupCart = originalItems.map(item => ({
                id: item.variant_id,
                quantity: item.quantity,
            }));

            await fetch('/cart/clear.js', { method: 'POST' });

            await addTemporaryProduct();

            await calculateShippingRates(cepUnmasked, country, province, wrapper, { originUfCode, destUfCode, originCity, destCity });

            await fetch('/cart/clear.js', { method: 'POST' });

            for (const item of backupCart) {
                await fetch('/cart/add.js', {
                    method: 'POST',
                    body: JSON.stringify({ id: item.id, quantity: item.quantity }),
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
            }
        } else {
            await addTemporaryProduct();

            await calculateShippingRates(cepUnmasked, country, province, wrapper, { originUfCode, destUfCode, originCity, destCity });

            await fetch('/cart/clear.js', { method: 'POST' });
        }

        btn.innerHTML = btn.dataset.text;
    }


    async function addTemporaryProduct() {
      const formElement = document.querySelector('form[action*="/cart/add"]');
      if (!formElement) {
        throw new Error('Formulário de produto não encontrado');
      }

      const idInput = formElement.querySelector('input[name="id"], select[name="id"]');
      const variantId = idInput && idInput.value ? idInput.value : null;
      if (!variantId) {
        throw new Error('ID da variante não encontrado no formulário');
      }

      const payload = {
        items: [
          {
            id: Number(variantId),
            quantity: 1,
          },
        ],
      };

      await fetch('/cart/add.js', {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
        },
      });
    }


    async function calculateShippingRates(cepUnmasked, country, province, wrapper, originDestMeta = {}) {
      // Incluir província (estado) para evitar 422 e mensagens de validação do Shopify
      console.log('[Frete Dinâmico] Calculando frete com Shopify', {
        origem: SENDER_ZIP_UNMASKED,
        destino: cepUnmasked,
        pais: country,
        estadoDestino: province || '(não informado)'
      });
      const params = new URLSearchParams();
      params.set('shipping_address[zip]', cepUnmasked);
      params.set('shipping_address[country]', country);
      if (province) {
        params.set('shipping_address[province]', province);
      }
      const ratesUrl = `/cart/shipping_rates.json?${params.toString()}`;

      const ratesResponse = await fetch(ratesUrl, { method: 'GET' });
      const ratesData = await ratesResponse.json();

      if (ratesResponse.ok && Array.isArray(ratesData.shipping_rates) && ratesData.shipping_rates.length > 0) {
        console.log('[Frenet/Shopify] shipping_rates recebidos:', ratesData.shipping_rates);
        let ratesHtml = '';
        ratesData.shipping_rates.forEach(rate => {
          const extracted = extractShopifyDeliveryInfo(rate);
          console.log('[Frenet/Shopify] Rate analisado:', {
            name: rate.name,
            source: rate.source || rate.carrier_service || '(desconhecido)',
            delivery_days: rate.delivery_days,
            delivery_range: rate.delivery_range,
          });
          if (extracted.hasDays) {
            console.log('[Frenet] Prazo informado pelo Shopify/Frenet para', rate.name, ':', extracted.daysText);
          } else {
            console.log('[Frenet] Shopify/Frenet NÃO informou prazo para', rate.name, '. Usando estimativa de origem/destino.');
          }
          const shopifyDays = extracted.hasDays ? extracted.daysText : '';
          const estimatedDays = estimateDeliveryDaysByOriginDest(originDestMeta);
          const deliveryDays = shopifyDays || estimatedDays || 'Prazo não informado';
          const serviceName = (rate.name || '').trim();
          const lname = serviceName.toLowerCase();
          const priceNum = typeof rate.price === 'string' ? parseFloat(rate.price) : (typeof rate.price === 'number' ? rate.price : NaN);
          const priceText = Number.isFinite(priceNum) ? formatCurrency(priceNum) : '';

          if (lname.includes('pac')) {
            ratesHtml += `<div class="td-frete-dinamico-rate"><strong class="td-frete-servico td-frete-servico--pac">PAC</strong> ${deliveryDays}${priceText ? ` <span class="td-frete-preco td-frete-preco--risco">${priceText}</span> <span class="td-frete-gratis">Grátis</span>` : ''}</div>`;
          } else if (lname.includes('sedex')) {
            ratesHtml += `<div class="td-frete-dinamico-rate"><strong class="td-frete-servico td-frete-servico--sedex">SEDEX</strong> ${deliveryDays}${priceText ? ` <span class="td-frete-preco">${priceText}</span>` : ''}</div>`;
          } else {
            ratesHtml += `<div class="td-frete-dinamico-rate"><strong class="td-frete-servico">${serviceName}</strong> ${deliveryDays}${priceText ? ` <span class="td-frete-preco">${priceText}</span>` : ''}</div>`;
          }
        });
        wrapper.querySelector('#frete-sucesso').innerHTML += `${ratesHtml}`;
        wrapper.querySelector('#frete-sucesso').removeAttribute('hidden');
      } else {
        wrapper.querySelector('#frete-aviso').innerHTML = `
          <p class="mb-0">Não foi possível encontrar opções de frete para o CEP informado.</p>
        `;
        wrapper.querySelector('#frete-aviso').removeAttribute('hidden');
      }
    }


    function formatLocation(data) {
      // Compatível com ViaCEP e BrasilAPI
      const city = data.localidade || data.city || '';
      const neighborhood = data.bairro || data.neighborhood || '';
      const street = data.logradouro || data.street || '';
      return [city, neighborhood, street].filter(Boolean).join(' - ');
    }


    function formatDeliveryDays(deliveryDays) {
      const lastDay = deliveryDays[deliveryDays.length - 1];
      return lastDay === 1
        ? '1 dia útil'
        : `${lastDay} dias úteis`;
    }

    function formatDaysNumber(n) {
      const d = Number(n);
      if (!Number.isFinite(d) || d <= 0) return '';
      return d === 1 ? '1 dia útil' : `${d} dias úteis`;
    }

    function extractShopifyDeliveryInfo(rate) {
      // Tenta extrair prazo do objeto retornado pelo Shopify/Frenet
      const info = { hasDays: false, daysText: '' };

      const dd = rate && rate.delivery_days;
      if (typeof dd === 'number') {
        info.hasDays = true;
        info.daysText = formatDaysNumber(dd);
        return info;
      }
      if (Array.isArray(dd) && dd.length > 0) {
        info.hasDays = true;
        info.daysText = formatDeliveryDays(dd);
        return info;
      }

      const dr = rate && rate.delivery_range;
      if (dr) {
        // Alguns apps retornam min/max em dias úteis como números
        if (typeof dr.min === 'number' && typeof dr.max === 'number') {
          const minText = formatDaysNumber(dr.min);
          const maxText = formatDaysNumber(dr.max);
          if (minText && maxText) {
            info.hasDays = true;
            info.daysText = dr.min === dr.max ? minText : `${dr.min}-${dr.max} dias úteis`;
            return info;
          }
        }
      }

      return info;
    }

    function estimateDeliveryDaysByOriginDest(meta) {
      const { originUfCode, destUfCode, originCity, destCity } = meta || {};
      if (!originUfCode || !destUfCode) return '';

      const norm = s => (s || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');

      // Mesma cidade: prazo mais curto
      if (originUfCode === destUfCode && originCity && destCity && norm(originCity) === norm(destCity)) {
        return '1-2 dias úteis';
      }

      // Mapa de regiões do IBGE
      const regionByUf = {
        AC: 'Norte', AL: 'Nordeste', AP: 'Norte', AM: 'Norte', BA: 'Nordeste', CE: 'Nordeste', DF: 'Centro-Oeste',
        ES: 'Sudeste', GO: 'Centro-Oeste', MA: 'Nordeste', MT: 'Centro-Oeste', MS: 'Centro-Oeste', MG: 'Sudeste',
        PA: 'Norte', PB: 'Nordeste', PR: 'Sul', PE: 'Nordeste', PI: 'Nordeste', RJ: 'Sudeste', RN: 'Nordeste',
        RS: 'Sul', RO: 'Norte', RR: 'Norte', SC: 'Sul', SP: 'Sudeste', SE: 'Nordeste', TO: 'Norte'
      };

      const originRegion = regionByUf[originUfCode];
      const destRegion = regionByUf[destUfCode];

      if (!originRegion || !destRegion) return '3-7 dias úteis';

      if (originUfCode === destUfCode) {
        return '2-3 dias úteis';
      }

      if (originRegion === destRegion) {
        return '3-5 dias úteis';
      }

      const neighboring = new Set([
        'Sudeste-Sul','Sul-Sudeste', 'Sudeste-Centro-Oeste','Centro-Oeste-Sudeste',
        'Nordeste-Centro-Oeste','Centro-Oeste-Nordeste', 'Norte-Nordeste','Nordeste-Norte'
      ]);
      const key = `${originRegion}-${destRegion}`;

      if (neighboring.has(key)) {
        return '5-8 dias úteis';
      }

      return '7-12 dias úteis';
    }

    function mapBrazilProvince(uf) {
      const mapping = {
        AC: 'Acre',
        AL: 'Alagoas',
        AP: 'Amapá',
        AM: 'Amazonas',
        BA: 'Bahia',
        CE: 'Ceará',
        DF: 'Distrito Federal',
        ES: 'Espírito Santo',
        GO: 'Goiás',
        MA: 'Maranhão',
        MT: 'Mato Grosso',
        MS: 'Mato Grosso do Sul',
        MG: 'Minas Gerais',
        PA: 'Pará',
        PB: 'Paraíba',
        PR: 'Paraná',
        PE: 'Pernambuco',
        PI: 'Piauí',
        RJ: 'Rio de Janeiro',
        RN: 'Rio Grande do Norte',
        RS: 'Rio Grande do Sul',
        RO: 'Rondônia',
        RR: 'Roraima',
        SC: 'Santa Catarina',
        SP: 'São Paulo',
        SE: 'Sergipe',
        TO: 'Tocantins',
      };
      return mapping[uf] || '';
    }


    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
      }).format(value);
    }


    function getFormData(form) {
      const formData = new FormData(form);
      const object = {};
      formData.forEach((value, key) => {
        object[key] = value;
      });
      return object;
    }


    const zipInput = document.querySelector('#td-frete-dinamico-cep');
    zipInput.addEventListener('input', function (e) {
      const value = e.target.value.replace(/\D/g, '');
      e.target.value =
        value.length > 5
          ? `${value.slice(0, 5)}-${value.slice(5, 8)}`
          : value;
    });
  });
</script>
